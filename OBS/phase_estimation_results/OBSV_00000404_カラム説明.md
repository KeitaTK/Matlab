# OBSV_data_00000404.csv 各カラムの説明（日本語）

このドキュメントは、`AP_Observer.cpp` の `Write_Observer_Log()` 関数で記録されるデータの各カラム（変数）の意味・内容を日本語でまとめたものです。

## カラム一覧と説明

| カラム名    | 説明                                              | 単位・備考 |
|:------------|:--------------------------------------------------|:-----------|
| **TimeUS**  | タイムスタンプ（マイクロ秒単位）                   | μs |
| **PLX**     | ペイロード外力 X成分（`_payload_filtered.x`）     | N（フィルタ後） |
| **PLY**     | ペイロード外力 Y成分（`_payload_filtered.y`）     | N（フィルタ後） |
| **PLZ**     | ペイロード外力 Z成分（`_payload_filtered.z`）     | N（フィルタ後） |
| **AX**      | RLS推定パラメータ X軸の**sin係数**（`rls_theta[0][0]`） | A_x（sin項の振幅） |
| **AY**      | RLS推定パラメータ Y軸の**sin係数**（`rls_theta[1][0]`） | A_y（sin項の振幅） |
| **BX**      | RLS推定パラメータ X軸の**cos係数**（`rls_theta[0][1]`） | B_x（cos項の振幅） |
| **BY**      | RLS推定パラメータ Y軸の**cos係数**（`rls_theta[1][1]`） | B_y（cos項の振幅） |
| **CX**      | RLS推定パラメータ X軸の**定常偏差**（`rls_theta[0][2]`） | C_x（DC成分） |
| **CY**      | RLS推定パラメータ Y軸の**定常偏差**（`rls_theta[1][2]`） | C_y（DC成分） |
| **F**       | **推定周波数**（`est_freq`）                        | Hz（位相バッファから計算） |
| **P**       | **位相補正量**（`phase_correction`）               | rad（累積補正値） |
| **X**       | **観測位相 X軸**（`phi_obs_x = ab_phase_unwrapped[0]`） | rad（atan2(-B_x, A_x)から計算） |
| **Y**       | **観測位相 Y軸**（`phi_obs_y = ab_phase_unwrapped[1]`） | rad（atan2(-B_y, A_y)から計算） |

---

## RLS（Recursive Least Squares）パラメータについて

RLSアルゴリズムは、外力が以下の形式で表現されると仮定しています：

$$F(t) = A \cdot \sin(\omega t - \phi) + B \cdot \cos(\omega t - \phi) + C$$

ここで：
- **A（AX, AY）**: sin項の振幅（RLS推定値）
- **B（BX, BY）**: cos項の振幅（RLS推定値）
- **C（CX, CY）**: 定常偏差・DC成分（RLS推定値）
- **ω**: 設定された外乱周波数（rad/s）
- **φ**: 観測位相（MATLABの atan2(-B, A)）

---

## 観測位相について

観測位相（**X**, **Y**）は、推定されたsin係数（A）とcos係数（B）から計算される位相情報です：

$$\phi_{obs} = \text{atan2}(-B, A)$$

この観測位相は以下の特徴があります：

- **連続性**: アンラップ処理により、位相ジャンプを補正した連続な値です
- **振幅依存**: 振幅（$\sqrt{A^2 + B^2}$）が小さい場合は位相が不安定になります（最小振幅 1e-3 でガード）
- **予測に使用**: `get_predicted_force()` で Δt秒後の外力予測に利用されます

予測外力は以下のように計算されます：

$$F_{pred}(t+\Delta t) = A \cdot \sin(\omega(t+\Delta t) - \phi_{obs}) + B \cdot \cos(\omega(t+\Delta t) - \phi_{obs}) + C$$

---

## 位相補正について

- **F（推定周波数）**: 位相バッファ（100サンプル）の傾き情報から推定される外乱周波数
- **P（位相補正量）**: RLSアルゴリズムの精度向上のために使用される累積補正値
  - 従来の時間ベース位相（ω*t）に P を減算して用いられます
  - 観測位相が直接使用される場合は、P の使用は最小化されます

---

## このプログラムで抜き出している情報

`plot_OBSV_00000404_all_columns.m` スクリプトは：
- 上記すべての数値カラムを時系列グラフ化し、`results` フォルダにPNG画像として保存しています。
- 時間軸は100Hzサンプリング（0.01秒刻み、行番号ベース）で作成しています。

---

## 主要な設定パラメータ

AP_Observerの初期化時に以下のパラメータが使用されます：

| パラメータ | デフォルト値 | 説明 |
|:----------|:-----------|:-----|
| `CORR_GAIN` | 0.004 | 外力に基づく姿勢補正ゲイン |
| `FILT_CUTOFF` | 20.0 Hz | 低域フィルタのカットオフ周波数 |
| `RLS_LAMBDA` | 0.98 | RLS忘却係数 |
| `RLS_COV_INIT` | 100.0 | RLS初期共分散値 |
| `DIST_FREQ` | 0.6 Hz | 周期外乱周波数（設定値） |
| `PRED_TIME` | 0.01 s | 予測時間（Δt） |
| `PHASE_CORR` | 1 | 位相補正有効/無効 |
| `PHASE_THRESH` | 10.0 rad | 位相補正の適用閾値 |

---

## 参考
- グラフファイル例: `OBSV_00000404_PLX.png`, `OBSV_00000404_F.png`, `OBSV_00000404_X.png` など
- スクリプト: `plot_OBSV_00000404_all_columns.m`
- ソースコード: `AP_Observer.cpp` の `Write_Observer_Log()` 関数

---

## ログフォーマット変更履歴

**新版（現在）**:
```
TimeUS, PLX, PLY, PLZ, AX, AY, BX, BY, CX, CY, F, P, X, Y
```

**旧版**:
```
TimeUS, PLX, PLY, PLZ, AX, AY, BX, BY, CX, CY, PRX, PRY, PRZ, ERR, EST_FREQ, CORR
```

**変更内容**:
- 削除: PRX, PRY, PRZ（予測外力は計算時に動的に生成）
- 削除: ERR（位相誤差）
- 短縮: EST_FREQ → F（推定周波数）
- 短縮: CORR → P（位相補正量）
- 追加: X, Y（観測位相 X軸, Y軸）
